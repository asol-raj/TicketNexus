<div class="container-fluid py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Internal Admin Dashboard</h1>
    <span class="badge bg-primary text-uppercase">Internal Admin</span>
  </div>

  <div class="row g-3">
    <!-- Left rail: actions -->
    <div class="col-12 col-md-3 col-lg-2">
      <div class="card shadow-sm">
        <div class="card-header fw-bold">Quick Actions</div>
        <div class="card-body d-grid gap-2">
          <a href="#createManager" class="btn btn-outline-warning btn-sm">Create Manager</a>
          <a href="#createEmployee" class="btn btn-outline-dark btn-sm">Create Employee</a>
        </div>
      </div>

      <!-- Create Manager -->
      <div id="createManager" class="card shadow-sm mt-3">
        <div class="card-header fw-bold">New Manager</div>
        <div class="card-body">
          <form id="createManagerForm" class="vstack gap-2">
            <input class="form-control" name="first_name" placeholder="First name (optional)">
            <input class="form-control" name="last_name" placeholder="Last name (optional)">
            <input class="form-control" name="username" placeholder="Username (optional)">
            <input class="form-control" name="email" type="email" placeholder="Email" required>
            <input class="form-control" name="password" type="password" placeholder="Password" required>
            <button class="btn btn-warning btn-sm" type="submit">Create Manager</button>
          </form>
          <div id="managerMsg" class="mt-2 small"></div>
        </div>
      </div>

      <!-- Create Employee (manager-aware) -->
      <div id="createEmployee" class="card shadow-sm mt-3">
        <div class="card-header fw-bold">New Employee</div>
        <div class="card-body">
          <div class="alert alert-info py-2 px-3 mb-2" id="noManagerAlert" style="display:none;">
            Create a manager first before adding employees.
          </div>
          <form id="createEmployeeForm" class="vstack gap-2">
            <input class="form-control" name="first_name" placeholder="First name (optional)">
            <input class="form-control" name="last_name" placeholder="Last name (optional)">
            <input class="form-control" name="username" placeholder="Username (optional)">
            <input class="form-control" name="email" type="email" placeholder="Email" required>
            <input class="form-control" name="password" type="password" placeholder="Password" required>

            <!-- appears only if >1 manager; hidden if exactly 1; blocked if 0 -->
            <select class="form-select" name="manager_id" id="employeeManagerSelect" style="display:none;">
              <option value="">Select manager…</option>
            </select>

            <button class="btn btn-dark btn-sm" type="submit" id="createEmployeeBtn">Create Employee</button>
          </form>
          <div id="employeeMsg" class="mt-2 small"></div>
        </div>
      </div>
    </div>

    <!-- Center: summary KPIs -->
    <div class="col-12 col-md-5 col-lg-7">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">Overview</div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6 col-lg-3 mb-3">
              <div class="fw-bold">Open Tickets</div>
              <div class="display-6" id="kpiOpenTickets"><?= summary.open_tickets ?></div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
              <div class="fw-bold">Total Employees</div>
              <div class="display-6" id="kpiTotalEmployees"><?= summary.total_employees ?></div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
              <div class="fw-bold">Logged In</div>
              <div class="display-6" id="kpiOnline"><?= summary.online_employees ?></div>
            </div>
            <div class="col-6 col-lg-3 mb-3">
              <div class="fw-bold">Logged Out</div>
              <div class="display-6" id="kpiOffline"><?= summary.offline_employees ?></div>
            </div>
          </div>

          <hr>

          <div class="row text-center">
            <div class="col-6 col-md-3 mb-3">
              <div class="fw-bold">Low</div>
              <div class="h3" id="slaLow"><?= summary.sla.low ?></div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="fw-bold">Medium</div>
              <div class="h3" id="slaMedium"><?= summary.sla.medium ?></div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="fw-bold">High</div>
              <div class="h3" id="slaHigh"><?= summary.sla.high ?></div>
            </div>
            <div class="col-6 col-md-3 mb-3">
              <div class="fw-bold">Urgent</div>
              <div class="h3" id="slaUrgent"><?= summary.sla.urgent ?></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: tickets list -->
    <div class="col-12 col-md-4 col-lg-3">
      <div class="card shadow-sm h-100">
        <div class="card-header fw-bold">Tickets</div>
        <div class="list-group list-group-flush" id="ticketList" style="max-height: 70vh; overflow:auto;">
          <? if (tickets && tickets.length) { ?>
            <? tickets.forEach(t => { ?>
              <div class="list-group-item">
                <div class="d-flex justify-content-between">
                  <strong>#<?= t.id ?> · <?= (t.subject || 'Ticket') ?></strong>
                  <span class="badge bg-secondary text-uppercase"><?= t.priority || 'n/a' ?></span>
                </div>
                <div class="small text-muted mb-2">
                  Status: <?= t.status || 'n/a' ?> · Assignee: <?= t.assignee_label || 'Unassigned' ?>
                </div>
                <div class="d-flex gap-2">
                  <select class="form-select form-select-sm assign-select" data-ticket-id="<?= t.id ?>">
                    <option value="">Assign to…</option>
                    <? assigns.employees.forEach(emp => { ?>
                      <option value="<?= emp.employee_id ?>"><?= emp.label ?></option>
                    <? }) ?>
                  </select>
                  <button class="btn btn-sm btn-primary do-assign" data-ticket-id="<?= t.id ?>">Reassign</button>
                </div>
              </div>
            <? }) ?>
          <? } else { ?>
            <div class="list-group-item text-muted">No tickets found.</div>
          <? } ?>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module" src="/js/internal.js"></script>
