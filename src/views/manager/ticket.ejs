<div class="container-fluid py-3" id="ticketPage" data-ticket-id="<?= ticket.id ?>" data-user-id="<?= user.id ?>">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex justify-content-start align-items-center gap-3 me-auto">
      <h2 class="d-inline">Ticket #
        <?= ticket.id ?> —
        <?= ticket.subject ?>
      </h2>
    </div>
    <?#= ticket.assignee_label || m.employee_id ?>
    <div class="d-flex align-items-center gap-2 me-5">
      <span class="select-label"> Assign To </span>
      <select id="assignSelect" class="form-select form-select-sm" style="width:auto;">
        <!-- Always include Unassigned option -->
        <option value="" <?=!ticket.assignee_label || !teamSelect.some(m=> m.label === ticket.assignee_label) ?
          "selected" : "" ?>>Unassigned</option>

        <? teamSelect.forEach(m => { ?>
        <option value="<?= m.employee_id ?>" <?=ticket.assignee_label===m.label ? "selected" : "" ?>>
          <?= m.label ?>
        </option>
        <? }) ?>
      </select>
      <button class="btn btn-sm btn-outline-primary" id="applyAssign">Assign</button>
    </div>



    <?
      let badgeClass = "bg-secondary";
      if (ticket.status === "open") badgeClass = "bg-info";
      else if (ticket.status === "in_progress") badgeClass = "bg-warning text-dark";
      else if (ticket.status === "resolved") badgeClass = "bg-success";
      else if (ticket.status === "closed") badgeClass = "bg-dark";
    ?>
    <div class="d-flex align-items-center gap-2">
      <span class="badge <?= badgeClass ?> text-uppercase" id="statusBadge">
        <?= ticket.status ?>
      </span>
      <select id="statusSelect" class="form-select form-select-sm" style="width:auto;">
        <option value="pending" <?=ticket.status==='open' ? 'selected' : '' ?>>Pending</option>
        <option value="in_progress" <?=ticket.status==='in_progress' ? 'selected' : '' ?>>In&nbsp;Progress</option>
        <option value="resolved" <?=ticket.status==='resolved' ? 'selected' : '' ?>>Resolved</option>
        <option value="closed" <?=ticket.status==='closed' ? 'selected' : '' ?>>Closed</option>
      </select>
      <button class="btn btn-sm btn-outline-primary" id="applyStatus">Update</button>
    </div>
  </div>

  <div class="row g-3">
    <!-- Left: details + comments -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm mb-3">
        <div class="card-header fw-bold">Details</div>
        <div class="card-body">
          <div class="mb-2">
            <strong>Priority:</strong>
            <span class="text-uppercase">
              <?
                  let badgeclass = 'bg-secondary';
                  if (ticket.priority === 'urgent') {
                    badgeclass = 'bg-danger';
                  } else if (ticket.priority === 'high') {
                    badgeclass = 'bg-warning';
                  } else if (ticket.priority === 'medium') {
                    badgeclass = 'bg-info';
                  } else if (ticket.priority === 'low') {
                    badgeclass = 'bg-success';
                  }
              ?>
              <span class="badge text-uppercase <?= badgeclass ?>">
                <?= ticket.priority || 'n/a' ?>
              </span>
            </span>
          </div>
          <div class="d-flex justify-content-between align-items-center gap-5 flex-wrap">
            <div class="mb-2"><strong>Raised by:</strong>
              <?= ticket.raised_by_label ?>
            </div>
            <div><strong>Assignee:</strong>
              <?= ticket.assignee_label || 'Unassigned' ?>
            </div>
            <div><strong>Created:</strong>
              <?= new Date(ticket.created_at).toLocaleString() ?>
            </div>
            <? if (ticket.due_at) { ?>
            <div><strong>Due:</strong>
              <?= new Date(ticket.due_at).toLocaleString() ?>
            </div>
            <? } ?>
          </div>
          <strong>Description:</strong>
          <span class="px-2 text-dark" style="background-color:rgb(255, 255, 195);">
            <?= ticket.description ?>
          </span>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header fw-bold">Progress / Follow-ups</div>
        <div class="card-body d-flex flex-column">
          <form id="commentForm" class="vstack gap-2 mb-3">
            <textarea class="form-control" name="content" id="commentContent" rows="3" placeholder="Write an update..."
              required></textarea>
            <button class="btn btn-primary btn-sm" type="submit">Post Update</button>
            <div id="commentMsg" class="small"></div>
          </form>

          <div id="commentList" class="vstack gap-3">
            <? if (comments && comments.length) { ?>
            <? comments.forEach(p => { ?>
            <div class="mb-3 border-bottom pb-2" data-comment-id="<?= p.id ?>" data-author-id="<?= p.author_id ?>">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>
                    <?= p.author_label || 'User' ?>
                  </strong>
                  <span class="small text-muted">·
                    <?= new Date(p.created_at).toLocaleString() ?>
                  </span>
                </div>
                <? if (p.author_id === user.id) { ?>
                <button class="btn edit-comment"><i class="bi bi-pencil-square"></i></button>
                <? } ?>
              </div>
              <div class="mt-1 comment-content" style="white-space:pre-wrap;">
                <?= p.content ?>
              </div>
            </div>
            <? }) ?>
            <? } else { ?>
            <div class="text-muted">No updates yet.</div>
            <? } ?>
          </div>
        </div>
      </div>
    </div>

    <!-- Right: attachments -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header fw-bold d-flex justify-content-between align-items-center">
          <span>Attachments</span>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addAttachmentsModal">
            <i class="bi bi-plus-lg"></i> Attachments
          </button>
        </div>
        <div class="card-body">
          <? if (attachments && attachments.length) { ?>
          <div class="row g-2" id="attachmentGrid">
            <? attachments.forEach(a => { ?>
            <div class="col-12 <?= a.is_image ? 'col-sm-6' : '' ?> attachment-item" data-attach-id="<?= a.id ?>">
              <div class="border rounded p-2 h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div class="small text-muted">
                    Uploaded by:
                    <?= a.uploader_label || 'Unknown' ?> ·
                    <?= new Date(a.uploaded_at).toLocaleString() ?>
                  </div>
                  <? if (a.uploaded_by === user.id) { ?>
                  <button class="btn btn-sm btn-outline-danger delete-attachment" data-id="<?= a.id ?>"><i
                      class="bi bi-trash"></i></button>
                  <? } ?>
                </div>
                <? if (a.is_image) { ?>
                <a href="/attachments/<?= a.id ?>" target="_blank" class="d-block">
                  <img src="/attachments/<?= a.id ?>" alt="attachment" class="img-fluid rounded">
                </a>
                <? } else { ?>
                <a class="d-block" href="/attachments/<?= a.id ?>" target="_blank">
                  <?= (a.file_path || '').split('/').slice(-1)[0] ?>
                </a>
                <? } ?>
              </div>
            </div>
            <? }) ?>
          </div>
          <? } else { ?>
          <div class="text-muted">No attachments.</div>
          <? } ?>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Add Attachments Modal -->
<div class="modal fade" id="addAttachmentsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="addAttachmentsForm" enctype="multipart/form-data">
      <div class="modal-header">
        <h5 class="modal-title">Add Attachments to Ticket #
          <?= ticket.id ?>
        </h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input class="form-control" type="file" name="attachments" multiple required>
        <div class="form-text">You can upload multiple files.</div>
      </div>
      <div class="modal-footer">
        <div id="addAttMsg" class="me-auto small"></div>
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Upload</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Comment Modal -->
<div class="modal fade" id="editCommentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="editCommentForm">
      <div class="modal-header">
        <h5 class="modal-title">Edit Comment</h5>
        <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <textarea class="form-control" id="editCommentTextarea" rows="4" required></textarea>
        <div id="editCommentMsg" class="small mt-2"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<script type="module" src="/js/ticket-internal-manager.js"></script>